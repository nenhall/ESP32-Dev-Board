# ESP32-WROOM 开发指南

## 目录
- [硬件准备](#硬件准备)
- [软件环境搭建](#软件环境搭建)
- [项目创建](#项目创建)
- [开发流程](#开发流程)
- [调试方法](#调试方法)
- [常见问题](#常见问题)

---

## 硬件准备

### 开发板规格
- **模块**: ESP32-WROOM-32
- **USB转串口芯片**: CH340
- **CPU**: 双核 240MHz
- **内存**: 520KB SRAM, 4MB Flash
- **Wi-Fi**: 802.11 b/g/n
- **蓝牙**: BLE + 经典蓝牙

### 必备硬件
1. ESP32-WROOM 开发板
2. Micro-USB 数据线（支持数据传输，非仅充电线）
3. 电脑（Windows/Mac/Linux）

### 可选硬件
- 杜邦线、面包板
- 外设模块（传感器、显示屏等）
- 3.3V/5V 电源模块

---

## 软件环境搭建

### 方案一：Arduino IDE（推荐新手）

#### 1. 安装 Arduino IDE
- 下载地址：https://www.arduino.cc/en/software
- 选择 1.8.x 或 2.x 版本

#### 2. 添加 ESP32 开发板支持
```
1. 打开 Arduino IDE
2. 文件 → 首选项
3. 在 "附加开发板管理器网址" 中添加：
   https://espressif.github.io/arduino-esp32/package_esp32_index.json
4. 确定
5. 工具 → 开发板 → 开发板管理器
6. 搜索 "esp32"，安装 "ESP32 by Espressif Systems"
```

#### 3. 选择开发板
```
工具 → 开发板 → esp32 → ESP32 Dev Module
```

#### 4. 安装 CH340 驱动
- **Windows**: 下载 http://www.wch.cn/download/CH341SER_EXE.html
- **Mac**: 下载 https://macdrivers.com/ch340-mac-driver
- **Linux**: 通常自动识别，或运行：
  ```bash
  sudo apt-get install CH340-driver
  ```

### 方案二：ESP-IDF（专业开发）

#### 1. 安装 ESP-IDF
```bash
# 克隆 ESP-IDF 仓库
git clone --recursive https://github.com/espressif/esp-idf.git

# 切换到最新版本
cd esp-idf
git checkout v5.1
git submodule update --init --recursive

# 安装依赖
./install.sh esp32
```

#### 2. 设置环境变量
```bash
. ./export.sh
```

#### 3. VSCode 开发环境
```
1. 安装 VSCode
2. 安装扩展: "ESP-IDF"
3. 命令面板 → "ESP-IDF: Configure ESP-IDF extension"
```

### 方案三：PlatformIO（跨平台）

#### 1. 安装 VSCode + PlatformIO
```
1. 安装 VSCode
2. 扩展 → 搜索 "PlatformIO IDE"
3. 安装并重启 VSCode
```

#### 2. 创建项目
```
1. PlatformIO 首页 → New Project
2. Board: ESP32 Dev Module
3. Framework: Arduino 或 ESP-IDF
```

---

## 项目创建

### Arduino IDE 项目

#### 1. 创建新项目
```
文件 → 新建文件 → 保存为 main.ino
```

#### 2. 基础代码框架
```cpp
// main.ino

// 定义引脚
#define LED_PIN 2  // 板载LED

void setup() {
  // 初始化串口
  Serial.begin(115200);
  delay(1000);

  // 设置引脚模式
  pinMode(LED_PIN, OUTPUT);

  Serial.println("ESP32 启动成功!");
}

void loop() {
  // 主循环
  digitalWrite(LED_PIN, HIGH);
  delay(1000);
  digitalWrite(LED_PIN, LOW);
  delay(1000);

  Serial.println("LED 闪烁");
}
```

#### 3. 编译上传
```
1. 选择正确的串口: 工具 → 端口 → COMx (Windows) 或 /dev/cu.usbserialxxx (Mac/Linux)
2. 点击上传按钮
3. 等待编译和上传完成
```

### ESP-IDF 项目

#### 1. 创建项目
```bash
cd ~/esp
cp -r $IDF_PATH/examples/get-started/hello_world my_project
cd my_project
```

#### 2. 项目结构
```
my_project/
├── CMakeLists.txt
├── main/
│   ├── CMakeLists.txt
│   └── main.c
├── sdkconfig
└── README.md
```

#### 3. 主程序
```c
// main/main.c

#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "esp_log.h"

#define LED_PIN 2

static const char *TAG = "MAIN";

void app_main(void)
{
    // 配置GPIO
    gpio_reset_pin(LED_PIN);
    gpio_set_direction(LED_PIN, GPIO_MODE_OUTPUT);

    ESP_LOGI(TAG, "ESP32 启动成功!");

    while(1) {
        gpio_set_level(LED_PIN, 1);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
        gpio_set_level(LED_PIN, 0);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
}
```

#### 4. 编译烧录
```bash
# 设置目标芯片
idf.py set-target esp32

# 编译
idf.py build

# 烧录（自动检测端口）
idf.py -p COMx flash

# 查看输出
idf.py -p COMx monitor
```

### PlatformIO 项目

#### 1. 项目配置
```ini
; platformio.ini

[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

; 串口波特率
monitor_speed = 115200

; 上传速度
upload_speed = 921600
```

#### 2. 主程序
```cpp
// src/main.cpp

#include <Arduino.h>

#define LED_PIN 2

void setup() {
  Serial.begin(115200);
  pinMode(LED_PIN, OUTPUT);
  Serial.println("ESP32 启动成功!");
}

void loop() {
  digitalWrite(LED_PIN, HIGH);
  delay(1000);
  digitalWrite(LED_PIN, LOW);
  delay(1000);
  Serial.println("LED 闪烁");
}
```

#### 3. 编译上传
```bash
# 编译
pio run

# 上传
pio run --target upload

# 监控串口
pio device monitor
```

---

## 开发流程

### 1. 硬件连接
```
1. 用 USB 线连接开发板到电脑
2. 检查设备管理器中的串口号（Windows: COM3, COM4...）
3. 确认驱动正确安装
```

### 2. 编写代码
- 使用编辑器编写代码
- 保存文件
- 编译检查错误

### 3. 编译上传
```
1. 选择正确的串口
2. 点击上传按钮
3. 等待编译完成
4. 自动烧录到开发板
```

### 4. 调试运行
```
1. 打开串口监视器
2. 设置波特率 115200
3. 查看输出信息
4. 根据输出调试程序
```

---

## 调试方法

### 串口调试
```cpp
// 输出调试信息
Serial.begin(115200);
Serial.println("调试信息");
Serial.printf("变量值: %d\n", value);

// 格式化输出
char buffer[100];
sprintf(buffer, "温度: %.2f°C", temperature);
Serial.println(buffer);
```

### LED 指示
```cpp
// 使用板载LED指示状态
#define LED_PIN 2

void blinkError() {
  while(1) {
    digitalWrite(LED_PIN, HIGH);
    delay(100);
    digitalWrite(LED_PIN, LOW);
    delay(100);
  }
}

void blinkSuccess() {
  for(int i=0; i<3; i++) {
    digitalWrite(LED_PIN, HIGH);
    delay(200);
    digitalWrite(LED_PIN, LOW);
    delay(200);
  }
}
```

### 断点调试（ESP-IDF）
```bash
# 使用 OpenOCD 进行调试
idf.py openocd

# 在另一个终端
xtensa-esp32-elf-gdb build/your_project.elf
```

---

## 常见问题

### 1. 找不到串口
**问题**: 设备管理器中没有显示 COM 端口
**解决**:
- 检查 USB 线是否支持数据传输
- 重新安装 CH340 驱动
- 尝试更换 USB 端口
- 更换 USB 数据线

### 2. 上传失败
**问题**: 连接超时或写入失败
**解决**:
- 检查串口号是否正确
- 按住 BOOT 按钮再点击上传
- 降低上传速度（921600 → 115200）
- 更换 USB 线或电脑端口

### 3. 编译错误
**问题**: 编译时出现各种错误
**解决**:
- 更新 ESP32 开发板包
- 清除缓存：工具 → "清除缓存"
- 重启 Arduino IDE
- 检查代码语法错误

### 4. 程序不运行
**问题**: 上传成功但程序不执行
**解决**:
- 按下 EN/RST 按钮复位
- 检查串口监视器波特率
- 添加 Serial.println() 调试
- 检查引脚定义是否正确

### 5. Wi-Fi 连接失败
**问题**: 无法连接到 Wi-Fi
**解决**:
- 检查 SSID 和密码
- 确保 Wi-Fi 为 2.4GHz（不支持 5GHz）
- 检查路由器的 MAC 过滤
- 增加连接超时时间

### 6. 内存不足
**问题**: 程序太大无法上传
**解决**:
- 分区表选择：工具 → Partition Scheme → "No OTA (2MB APP/2MB SPIFFS)"
- 优化代码，减少库的使用
- 移除不必要的功能

---

## 下一步

- 查看 [快速开始指南](./快速开始.md) 了解第一个示例
- 阅读 [ESP32 技术参考手册](https://www.espressif.com/sites/default/files/documentation/esp32_datasheet_cn.pdf)
- 探索 [示例代码](../examples/) 目录
- 加入 ESP32 中文社区

---

## 参考资料

- [ESP32 官方文档](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/)
- [Arduino ESP32 核心库](https://github.com/espressif/arduino-esp32)
- [ESP32 数据手册](https://www.espressif.com/sites/default/files/documentation/esp32_datasheet_cn.pdf)
- [乐鑫科技中文论坛](https://www.cnblogs.com/espressif/)
